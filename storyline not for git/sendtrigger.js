// Функция для экранирования специальных символов в строке
// Это защищает промпт от инъекций и некорректной интерпретации
function escapeStringForPrompt(str) {
    // Проверяем, что на вход пришла именно строка
    if (typeof str !== 'string') {
      return "";
    }
    // 1. Сначала заменяем обратный слэш. Это важно делать в первую очередь.
    // 2. Затем заменяем двойные кавычки.
    return str
      .replace(/\\/g, '\\\\') // Заменяем \ на \\
      .replace(/"/g, '\\"');  // Заменяем " на \"
  }
  
  // Получаем доступ к плееру Storyline
  const player = GetPlayer();
  
  // 1. ПОЛУЧАЕМ ОТВЕТ ПОЛЬЗОВАТЕЛЯ И ЭКРАНИРУЕМ ЕГО
  const rawUserAnswer = player.GetVar("UserResponse") || player.GetVar("UserResponce") || "";
  const userAnswer = escapeStringForPrompt(rawUserAnswer);
  
  // 2. ФОРМИРУЕМ ПРОМПТ С ТРЕБОВАНИЕМ ВЕРНУТЬ JSON
  // Теперь переменная userAnswer безопасна для вставки в строку
  const systemPrompt = `
  Ты — опытный HR-эксперт и коуч по менеджменту. Твоя задача — оценивать ответы руководителей в тренировочных сценариях.
  
  ---
  КОНТЕКСТ СИТУАЦИИ:
  Ваш сотрудник выполняет работу некачественно. Он знает, как нужно делать, но то тут не доделает, то сделает плохо. Когда вы ему говорите о том, что что-то сделано не так, он просто исправляет. Вы хотите поговорить с сотрудником, чтоб изменить его отношение к работе.
  
  ---
  ТЕОРЕТИЧЕСКАЯ БАЗА ДЛЯ ОЦЕНКИ:
  - План разговора: цель, позитив, ситуация, самооценка, своя оценка, выводы, рекомендации.
  - Правила: оценка действий, конкретика, вовлечение, честность, план действий.
  - НЕ "БУТЕРБРОД": Начало с позитива для установления контакта — это правильно. Не путай это с "бутербродом".
  `;

  const finalPrompt = `
  ОТВЕТ РУКОВОДИТЕЛЯ ДЛЯ ОЦЕНКИ:
  "${userAnswer}"
  
  ---
  ТВОЯ ЗАДАЧА:
  Проанализируй ответ руководителя. Твой ответ ДОЛЖЕН БЫТЬ СТРОГО В ФОРМАТЕ JSON.
  Не добавляй никаких пояснений до или после JSON. Только валидный JSON-объект.
  
  Структура JSON должна быть следующей:
  {
    "overall": "Твой общий вывод в одном предложении",
    "goodPoints": [
      "Первый положительный момент",
      "Второй положительный момент"
    ],
    "improvementPoints": [
      "Первый пункт, что можно улучшить",
      "Второй пункт, что можно улучшить"
    ]
  }
  
  - В "goodPoints" перечисли, какие шаги и правила из теории были соблюдены.
  - В "improvementPoints" перечисли, какие шаги и правила упущены. Если все хорошо, верни пустой массив [].
  - Говори на "ты" с руководителем.
  `;
  
  // 3. УНИВЕРСАЛЬНАЯ ОТПРАВКА
  // Сначала передаём финальный промпт в рекордер, затем даём команду отправки.
  // Если записано аудио — отправится аудио; если нет — уйдёт текст (finalPrompt).
  const iframes = Array.from(document.querySelectorAll('iframe'));
  if (iframes.length === 0) {
    alert("Ошибка: Веб-объекты не найдены на слайде.");
  } else {
    iframes.forEach((ifr) => {
      if (ifr && ifr.contentWindow) {
        ifr.contentWindow.postMessage({ type: 'startRecordingWithPrompt', payload: { prompt: finalPrompt, system: systemPrompt } }, '*');
        ifr.contentWindow.postMessage({ type: 'recorderSend' }, '*');
      }
    });
  }