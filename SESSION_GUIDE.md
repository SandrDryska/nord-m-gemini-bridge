# Руководство по сессиям в AI Bridge

## Обзор

Система теперь поддерживает **сессии диалогов** — ИИ помнит историю беседы и отвечает в контексте предыдущих сообщений. Это делает диалоги более естественными и связными.

## Ключевые возможности

✅ **Память диалога** — ИИ помнит что говорили раньше  
✅ **Автоматическое управление** — контекст обрезается при превышении лимитов  
✅ **Управление из Storyline** — простые команды для сброса/завершения  
✅ **Обратная совместимость** — старые триггеры работают без изменений  

## Быстрый старт

### 1. Переменные в Storyline

Создайте эти переменные в вашем проекте:

- **SessionId** (текст) — ID текущей сессии
- **UserResponse** (текст) — ввод пользователя (как раньше)
- **DialogueFull** (текст) — опционально, для совместимости

### 2. Базовый триггер диалога

Замените ваш текущий триггер на этот:

```javascript
// ОСНОВНОЙ ТРИГГЕР (скопируйте из session-triggers.js)
function dialogTriggerWithSessions() {
    // ... полный код в файле session-triggers.js
}
```

### 3. Управление сессиями

```javascript
// В начале нового кейса
startNewSessionTrigger();

// При завершении кейса  
endSessionTrigger();

// Для сброса контекста (начать диалог заново)
resetSessionContextTrigger();
```

## Подробное описание

### Как работают сессии

1. **При первом запросе** — создается новая сессия с уникальным ID
2. **При следующих запросах** — история загружается и добавляется новое сообщение
3. **При превышении лимита** — старые сообщения автоматически удаляются (скользящее окно)
4. **При завершении** — сессия удаляется с сервера

### Команды webrecorder

| Команда | Описание |
|---------|----------|
| `startNewSession` | Создать новую сессию |
| `endSession` | Завершить сессию на сервере |
| `resetSession` | Сбросить контекст сессии |
| `startRecordingWithPrompt` | Установить промпт (теперь с sessionId) |
| `recorderSend` | Отправить аудио или текст |

### События от webrecorder

| Событие | Данные | Описание |
|---------|--------|----------|
| `sessionCreated` | `{sessionId}` | Сессия создана |
| `sessionEnded` | `{sessionId}` | Сессия завершена |
| `sessionReset` | `{sessionId}` | Контекст сброшен |
| `geminiResponse` | `{generatedText, turns, sessionId}` | Ответ ИИ с информацией о сессии |

## Сценарии использования

### 1. Простой диалог с памятью

```javascript
// 1. В начале слайда
startNewSessionTrigger();

// 2. При каждой реплике
dialogTriggerWithSessions();

// 3. В конце слайда
endSessionTrigger();
```

### 2. Длинный диалог с промежуточными сбросами

```javascript
// Начинаем сессию
startNewSessionTrigger();

// ... диалог ...

// Сброс для новой темы (без создания новой сессии)
resetSessionContextTrigger();

// ... продолжение диалога ...

// Завершение
endSessionTrigger();
```

### 3. Переход между слайдами с сохранением контекста

```javascript
// На первом слайде
startNewSessionTrigger();

// На промежуточных слайдах — только диалог
dialogTriggerWithSessions();

// На последнем слайде
endSessionTrigger();
```

## Технические детали

### Хранение данных

- **Backend**: Netlify Blobs с TTL 60 минут
- **Формат**: JSON с массивом сообщений `{role, text, timestamp}`
- **Лимиты**: Максимум 20 сообщений в сессии

### Автоматическая обрезка

Когда история превышает 20 сообщений, старые удаляются автоматически. Система возвращает `turns` в ответе для отслеживания длины диалога.

### Обратная совместимость

- Если не передавать `sessionId` — работает как раньше (без памяти)
- Все старые триггеры продолжают функционировать
- Провайдеры поддерживают оба формата: старый и новый

## Отладка

### Проверка статуса сессии

```javascript
checkSessionStatusTrigger(); // Показывает текущий sessionId и длину диалога
```

### Логи в консоли

Открыв DevTools браузера, вы увидите:
- `[WebRecorder] Создана новая сессия: sess_xxx`
- `[Provider] yandex (text pipeline with session)`
- `[Session] Ошибка загрузки сессии: ...`

### Переменные Storyline

Проверьте значения переменных:
- `SessionId` должен содержать строку типа `sess_abc123_xyz`
- Если пустой — сессия не создана или завершена

## Миграция с предыдущей версии

1. **Добавьте переменную** `SessionId` в Storyline
2. **Замените триггеры** на версии из `session-triggers.js`
3. **Добавьте управление сессиями** в начало/конец кейсов
4. **Протестируйте** — старые триггеры работают без изменений

## Ограничения

- **TTL сессий**: 60 минут неактивности
- **Максимум сообщений**: 20 в сессии
- **Зависимость от Netlify Blobs**: требует развертывания на Netlify

## Поддержка

При проблемах:
1. Проверьте логи в консоли браузера
2. Убедитесь что `SessionId` установлен корректно
3. Проверьте что webrecorder загружен и отвечает на `bridgeReady`
